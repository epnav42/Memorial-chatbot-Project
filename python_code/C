from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QTextEdit, 
    QLineEdit, QPushButton, QLabel, QFrame
)
from PyQt6.QtCore import QThread, pyqtSignal, QTimer, Qt, QObject
import sys
import time

# =======================================================================
# [1] ë”¥ëŸ¬ë‹ ì‘ì—…ì ìŠ¤ë ˆë“œ (DL Worker Thread)
# =======================================================================
class DLWorker(QThread):
    # ì‘ì—… ì™„ë£Œ ì‹œ ì±—ë´‡ ì‘ë‹µì„ GUIë¡œ ë³´ë‚´ê¸° ìœ„í•œ ì‹œê·¸ë„ (Signal) ì •ì˜
    response_ready = pyqtSignal(str)

    def __init__(self, user_message: str, chat_history: list):
        super().__init__()
        self.user_message = user_message
        self.chat_history = chat_history # ë¬¸ë§¥ ìœ ì§€ë¥¼ ìœ„í•œ ëŒ€í™” ê¸°ë¡
        self.model_status = "Loaded" 

    def run(self):
        """
        ì´ ë©”ì„œë“œ ì•ˆì—ì„œ ë¡œì»¬ ë”¥ëŸ¬ë‹ ëª¨ë¸ì„ ë¡œë“œí•˜ê³  ì¶”ë¡ í•©ë‹ˆë‹¤.
        """
        if self.model_status == "Error":
            self.response_ready.emit("[ì˜¤ë¥˜] ëª¨ë¸ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.")
            return

        print(f"DLWorker: ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ ì¤‘... ({self.user_message})")
        
        try:
            # 1. ì‹¤ì œ ëª¨ë¸ ì¶”ë¡  (Inference) ì‹œë®¬ë ˆì´ì…˜
            # ì´ ì‹œê°„ ë™ì•ˆ GUIëŠ” ë©ˆì¶”ì§€ ì•ŠìŠµë‹ˆë‹¤.
            time.sleep(3) 

            # 2. ì±—ë´‡ í˜ë¥´ì†Œë‚˜ ë‹µë³€ ìƒì„± (ì‹¤ì œ ëª¨ë¸ ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´)
            if "í”„ë¡œì íŠ¸" in self.user_message or "íŒ€ì›" in self.user_message:
                bot_response = "ë‹¤í¬ ëª¨ë“œ ì ìš©ì€ ì‹œì¸ì„± ê°œì„ ì— ë§¤ìš° ì¢‹ì€ íŒë‹¨ì…ë‹ˆë‹¤. ì´ì œ ëª¨ë¸ í†µí•©ì— ì§‘ì¤‘í•©ì‹œë‹¤."
            elif "ì—”í„°" in self.user_message:
                bot_response = "ë„¤, ì´ì œ ì „ì†¡ ë²„íŠ¼ ì—†ì´ ì—”í„° í‚¤ë§Œìœ¼ë¡œë„ ë©”ì‹œì§€ ì „ì†¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì‚¬ìš©ì ê²½í—˜ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤."
            else:
                bot_response = f"í˜ë¥´ì†Œë‚˜ì˜ ë§íˆ¬ë¡œ ë‹µë³€í•©ë‹ˆë‹¤: ë‹¤í¬ ëª¨ë“œì—ì„œë„ ì™„ë²½í•˜ê²Œ ë³´ì…ë‹ˆë‹¤. '{self.user_message}' ë©”ì‹œì§€ëŠ” í™•ì‹¤íˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            
        except Exception as e:
            bot_response = f"[DL ëª¨ë¸ ì˜¤ë¥˜] ì¶”ë¡  ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œ ë°œìƒ: {str(e)}"

        # 3. GUI ìŠ¤ë ˆë“œì— ë‹µë³€ì„ ì „ë‹¬ (ì•ˆì „í•œ ë°©ì‹)
        self.response_ready.emit(bot_response)


# =======================================================================
# [2] GUI ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤ (ë‹¤í¬ ëª¨ë“œ ì ìš©)
# =======================================================================
class AIChatBotGUI(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("ì¡¸ì—… ì‘í’ˆ - í˜ë¥´ì†Œë‚˜ ì±—ë´‡ (ìµœì¢… GUI í”„ë ˆì„ì›Œí¬)")
        self.setGeometry(200, 200, 700, 750)
        self.current_worker = None
        self.chat_history = [] # ëŒ€í™” ë¬¸ë§¥ ì €ì¥ì„ ìœ„í•œ ë¦¬ìŠ¤íŠ¸
        self.init_ui()

    def init_ui(self):
        # ğŸŸ¢ QSS: ì „ì²´ í°íŠ¸ ë° ë°°ê²½ ì„¤ì • 
        self.setStyleSheet("""
            QWidget {
                background-color: #1e1e1e; /* ğŸŒ‘ ì „ì²´ ë°°ê²½ì„ ê²€ì • ê³„ì—´ë¡œ ë³€ê²½ */
                font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
                color: #ecf0f1; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë°ê²Œ ì„¤ì • */
            }
        """)

        layout = QVBoxLayout(self)
        layout.setContentsMargins(15, 15, 15, 15)
        layout.setSpacing(10)

        # íƒ€ì´í‹€ ìœ„ì ¯
        title_label = QLabel("âœ¨ í˜ë¥´ì†Œë‚˜ ì±—ë´‡ GUI ì‹œì—°")
        title_label.setAlignment(Qt.AlignmentFlag.AlignCenter) 
        title_label.setStyleSheet("""
            QLabel {
                font-size: 28px; 
                font-weight: 600; 
                color: #3498db; /* íƒ€ì´í‹€ ìƒ‰ìƒ ê°•ì¡° */
                padding: 10px;
            }
        """)
        layout.addWidget(title_label)

        # ì±„íŒ… ì¶œë ¥ì°½ (QSSë¡œ ë””ìì¸ ê°•í™”)
        self.chat_output = QTextEdit()
        self.chat_output.setReadOnly(True)
        self.chat_output.setStyleSheet("""
            QTextEdit {
                background-color: #2c2c2c; /* ì±„íŒ…ì°½ ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
                border: 1px solid #3a3a3a; 
                padding: 15px; 
                border-radius: 15px;
                font-size: 15px;
                color: #ecf0f1; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë°ê²Œ */
                line-height: 1.5;
            }
        """)
        layout.addWidget(self.chat_output)
        
        # ìƒíƒœ í‘œì‹œì°½
        self.status_label = QLabel("ğŸŸ¢ AI ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. (ì—”í„°í‚¤ ì „ì†¡)")
        self.status_label.setStyleSheet("color: #2ecc71; padding-top: 5px; font-weight: bold;") # ìƒíƒœ í‘œì‹œ ìƒ‰ìƒë„ ë°ê²Œ ë³€ê²½
        layout.addWidget(self.status_label)

        # ì…ë ¥ ì»¨í…Œì´ë„ˆ (ë²„íŠ¼ ì—†ì´ ì…ë ¥ì°½ë§Œ í¬í•¨)
        input_container = QFrame()
        input_layout = QVBoxLayout(input_container)
        input_layout.setContentsMargins(0, 0, 0, 0)
        input_layout.setSpacing(8)

        # ğŸš€ í•µì‹¬: ì‚¬ìš©ì ì…ë ¥ì°½
        self.chat_input = QLineEdit()
        self.chat_input.setPlaceholderText("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  ì—”í„° í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”...")
        self.chat_input.returnPressed.connect(self.send_message) 
        self.chat_input.setStyleSheet("""
            QLineEdit {
                padding: 12px; 
                border: 2px solid #3498db; 
                border-radius: 20px;
                font-size: 16px;
                background-color: #3c3c3c; /* ì…ë ¥ì°½ ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
                color: #ecf0f1; /* ì…ë ¥ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë°ê²Œ */
            }
            QLineEdit:disabled {
                background-color: #4a4a4a; /* ë¹„í™œì„±í™” ì‹œ ë” ì–´ë‘¡ê²Œ */
            }
        """)
        input_layout.addWidget(self.chat_input)

        layout.addWidget(input_container)
        
        # ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€
        self.chat_output.append(self._format_bot_message("ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì¡¸ì—… ì‘í’ˆ í˜ë¥´ì†Œë‚˜ ì±—ë´‡ì˜ GUIì…ë‹ˆë‹¤. ë‹¤í¬ ëª¨ë“œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."))


    def send_message(self):
        """ ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ í˜¸ì¶œë˜ì–´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  DLWorkerë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. """
        user_msg = self.chat_input.text().strip()
        # ì…ë ¥ì´ ì—†ê±°ë‚˜, ì´ë¯¸ ì‘ì—… ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
        if not user_msg or (self.current_worker and self.current_worker.isRunning()):
            return

        # 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥ (HTML ë§í’ì„  ì‚¬ìš©)
        self.chat_output.append(self._format_user_message(user_msg))
        self.chat_input.clear()
        
        # 2. ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
        self.chat_history.append({"role": "user", "content": user_msg})

        # 3. GUI ë¹„í™œì„±í™” ë° ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸° ì²˜ë¦¬ ì‹œì‘ ì•Œë¦¼)
        self.chat_input.setEnabled(False) 
        self.status_label.setText("â³ ë”¥ëŸ¬ë‹ ëª¨ë¸ì´ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...")
        
        # 4. DLWorker ìŠ¤ë ˆë“œ ì‹œì‘
        self.current_worker = DLWorker(user_msg, self.chat_history) 
        self.current_worker.response_ready.connect(self.handle_response)
        self.current_worker.start()
        self.chat_output.ensureCursorVisible() # ìë™ ìŠ¤í¬ë¡¤

    def handle_response(self, response: str):
        """ DLWorkerë¡œë¶€í„° ìµœì¢… ì‘ë‹µì„ ë°›ì•„ GUIì— í‘œì‹œí•˜ëŠ” ìŠ¬ë¡¯ (Slot)ì…ë‹ˆë‹¤. """
        
        # 1. GUI ë³µêµ¬
        self.chat_input.setEnabled(True) 
        self.status_label.setText("âœ… ë‹µë³€ ìˆ˜ì‹  ì™„ë£Œ. ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")

        # 2. ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
        self.chat_history.append({"role": "bot", "content": response})

        # 3. íƒ€ì´í•‘ íš¨ê³¼ë¡œ ì¶œë ¥
        self.display_typing_effect(response)
        
        self.current_worker = None
        self.chat_output.ensureCursorVisible()

    # --- HTML ë§í’ì„  ìƒì„± í—¬í¼ í•¨ìˆ˜ ---
    def _format_user_message(self, msg: str) -> str:
        """ ì‚¬ìš©ì ë©”ì‹œì§€ (ìš°ì¸¡ ì •ë ¬, íŒŒë€ìƒ‰ ë°°ê²½) HTML í¬ë§· """
        # ì‚¬ìš©ì ë§í’ì„ ì€ ë‹¤í¬ ëª¨ë“œì—ì„œë„ ëŒ€ë¹„ê°€ ë†’ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ ìœ ì§€
        return f"""
        <div style="text-align: right; margin-bottom: 10px;">
            <div style="
                display: inline-block; 
                background-color: #3498db; 
                color: white; 
                padding: 10px 15px; 
                border-radius: 18px 18px 3px 18px; 
                max-width: 70%;
                font-size: 15px;
            ">
                {msg}
            </div>
        </div>
        """

    def _format_bot_message(self, msg: str) -> str:
        """ ì±—ë´‡ ë©”ì‹œì§€ (ì¢Œì¸¡ ì •ë ¬, ì–´ë‘ìš´ íšŒìƒ‰ ë°°ê²½) HTML í¬ë§· """
        # ì±—ë´‡ ë§í’ì„  ë°°ê²½ì„ ì–´ë‘ìš´ ê³„ì—´ë¡œ ë³€ê²½í•˜ê³  í…ìŠ¤íŠ¸ëŠ” ë°ê²Œ ë³€ê²½
        return f"""
        <div style="text-align: left; margin-bottom: 10px;">
            <div style="
                display: inline-block; 
                background-color: #3a3a3a; /* ì±—ë´‡ ë°°ê²½ìƒ‰ì„ ì–´ë‘ìš´ ê³„ì—´ë¡œ ë³€ê²½ */
                color: #ecf0f1; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë°ê²Œ ìœ ì§€ */
                padding: 10px 15px; 
                border-radius: 18px 18px 18px 3px; 
                max-width: 70%;
                font-size: 15px;
            ">
                {msg}
            </div>
        </div>
        """
    
    # --- íƒ€ì´í•‘ íš¨ê³¼ ë¡œì§ ---
    def display_typing_effect(self, message: str):
        """
        QTimerë¥¼ ì‚¬ìš©í•˜ì—¬ ì±—ë´‡ ë©”ì‹œì§€ë¥¼ í•œ ê¸€ìì”© ì¶œë ¥í•˜ëŠ” íš¨ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.
        """
        self.full_message = message
        self.char_index = 0
        
        # ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì¤‘ì§€
        if hasattr(self, '_timer') and self._timer.isActive():
            self._timer.stop()
            
        self._timer = QTimer(self)
        self._timer.timeout.connect(self._add_char)
        self._timer.start(20) # 20ms ê°„ê²©ìœ¼ë¡œ ë¬¸ì ì¶”ê°€

    def _add_char(self):
        if self.char_index < len(self.full_message):
            char = self.full_message[self.char_index]
            
            cursor = self.chat_output.textCursor()
            cursor.movePosition(cursor.MoveOperation.End)
            
            if self.char_index == 0:
                # ì²« ë¬¸ìì¼ ë•Œ: ì„ì‹œ ë§í’ì„  HTMLì„ ìƒì„±í•˜ì—¬ append
                temp_msg = self._format_bot_message(char)
                self.chat_output.append(temp_msg)
            else:
                # ì´í›„ ë¬¸ìì¼ ë•Œ: ë§ˆì§€ë§‰ í…ìŠ¤íŠ¸ ë¸”ë¡ì— ë¬¸ì ì‚½ì…
                cursor.insertText(char)
            
            self.char_index += 1
            self.chat_output.ensureCursorVisible() # ìë™ ìŠ¤í¬ë¡¤
        else:
            # íƒ€ì´í•‘ ì™„ë£Œ í›„ íƒ€ì´ë¨¸ ì •ì§€
            self._timer.stop()
            del self._timer
            self.chat_output.ensureCursorVisible()


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = AIChatBotGUI()
    window.show()
    sys.exit(app.exec())
